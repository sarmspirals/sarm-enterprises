<!DOCTYPE html>
<html>
<head>
    <title>Clean Firestore Data</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getFirestore, collection, getDocs, updateDoc, doc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyAZe6bywYSgnMFZsef1xgfPFQBkw4y7tco",
            authDomain: "sarm-enterprises.firebaseapp.com",
            projectId: "sarm-enterprises",
            storageBucket: "sarm-enterprises.firebasestorage.app",
            messagingSenderId: "790231205096",
            appId: "1:790231205096:web:656c5fc47c6a675e1ef55d",
            measurementId: "G-5M1ZM089KH"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        async function cleanData() {
            try {
                const button = document.getElementById('cleanBtn');
                button.disabled = true;
                button.textContent = 'Cleaning...';
                
                const productsRef = collection(db, "products");
                const snapshot = await getDocs(productsRef);
                
                let cleaned = 0;
                
                for (const docSnap of snapshot.docs) {
                    const data = docSnap.data();
                    const images = data.images || [];
                    const fixedImages = images.map(img => {
                        if (!img) return img;
                        
                        // Remove duplicate prefix
                        if (img.includes('assets/products/assets/products/')) {
                            return img.replace('assets/products/assets/products/', '');
                        }
                        
                        // Remove single prefix
                        if (img.startsWith('assets/products/')) {
                            return img.replace('assets/products/', '');
                        }
                        
                        return img;
                    });
                    
                    // Update if changed
                    if (JSON.stringify(images) !== JSON.stringify(fixedImages)) {
                        await updateDoc(doc(db, "products", docSnap.id), {
                            images: fixedImages
                        });
                        cleaned++;
                        console.log(`Cleaned: ${data.name || docSnap.id}`);
                    }
                }
                
                button.textContent = `Done! Cleaned ${cleaned} products`;
                alert(`Cleaned ${cleaned} products!`);
                
            } catch (error) {
                console.error("Error:", error);
                alert("Error: " + error.message);
                document.getElementById('cleanBtn').textContent = 'Error - Try Again';
                document.getElementById('cleanBtn').disabled = false;
            }
        }
        
        window.cleanData = cleanData;
    </script>
    <style>
        body { font-family: Arial; padding: 40px; text-align: center; }
        button { padding: 15px 30px; font-size: 18px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:disabled { background: #ccc; }
    </style>
</head>
<body>
    <h1>Clean Firestore Image Data</h1>
    <p>This will remove duplicate "assets/products/" prefixes from your image paths.</p>
    <button id="cleanBtn" onclick="cleanData()">Clean Firestore Data</button>
    <p><small>After cleaning, refresh your main website to see the changes.</small></p>
</body>
</html>
